name: Dependency Updates

on:
  schedule:
    # Run monthly on the 1st day at 3 AM UTC
    - cron: '0 3 1 * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.13

    - name: Update uv.lock file
      run: |
        # Update all dependencies to their latest compatible versions
        uv lock --upgrade

    - name: Install updated dependencies
      run: uv sync --group dev

    - name: Run basic tests to ensure compatibility
      run: |
        # Run a quick test to ensure everything still works
        uv run pytest tests/ -x --tb=short || echo "Tests failed with new dependencies"

    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet uv.lock; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update dependencies"
        title: "ðŸ”„ Monthly Dependency Updates"
        body: |
          This PR contains automated dependency updates for the monthly maintenance cycle.

          ## Changes
          - Updated `uv.lock` with latest compatible versions of all dependencies

          ## Testing
          - [ ] Basic test suite passes
          - [ ] Security checks pass
          - [ ] Manual testing of core functionality

          ## Notes
          Please review the changes carefully before merging. Pay special attention to:
          - Major version bumps that might introduce breaking changes
          - Security-related updates
          - Changes in test behavior

          This PR was automatically created by the dependency update workflow.
        branch: automated/dependency-updates
        base: main
        labels: |
          dependencies
          automated
        delete-branch: true
